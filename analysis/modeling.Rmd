---
title: "Modeling"
---
<style type="text/css">
  body{
  font-size: 16pt;
}
</style>

```{r include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE,
                      message = FALSE)

```

```{r load_libraries}

library(tidyverse)

library(tidymodels)

library(baguette)

library(embed)

library(workflowsets)

```

```{r parameters}

professions = c(
  "manager",
  "business",
  "financialop",
  "computer",
  "architect",
  "scientist",
  "socialworker",
  "postseceduc",
  "legaleduc",
  "artist",
  "lawyerphysician",
  "healthcare",
  "healthsupport",
  "protective",
  "foodcare",
  "building",
  "sales",
  "officeadmin",
  "farmer",
  "constructextractinstall",
  "production",
  "transport"
)

```

```{r load_data}

data("train_set")

train_set_transformed = train_set %>%
  rename(ID = 1) %>%
  pivot_longer(cols = all_of(professions), names_to = "profession") %>%
  filter(value == 1) %>%
  select(-value) %>%
  mutate(profession = factor(profession))%>% 
  rowwise() %>% 
  mutate(white = 1 - sum(c_across(c("black","hisp","otherrace")))) %>% 
  ungroup() %>% 
  pivot_longer(cols = c(c("black","hisp","otherrace","white")),
               names_to = "race") %>% 
  filter(value == 1) %>% 
  select(-value) %>% 
  rowwise() %>% 
  mutate(west = 1 - sum(c_across(c("northeast","northcentral","south")))) %>% 
  ungroup() %>% 
  pivot_longer(cols = c(c("northeast","northcentral","south","west")),
               names_to = "area") %>%
  filter(value == 1) %>%
  select(-value) %>%
  identity()

data("test_set")

test_set = test_set %>%
  rename(ID = 1) %>%
  pivot_longer(cols = all_of(professions), names_to = "profession") %>%
  filter(value == 1) %>%
  select(-value) %>%
  mutate(profession = factor(profession))%>% 
  rowwise() %>% 
  mutate(white = 1 - sum(c_across(c("black","hisp","otherrace")))) %>% 
  ungroup() %>% 
  pivot_longer(cols = c(c("black","hisp","otherrace","white")),
               names_to = "race") %>% 
  filter(value == 1) %>% 
  select(-value) %>% 
  rowwise() %>% 
  mutate(west = 1 - sum(c_across(c("northeast","northcentral","south")))) %>% 
  ungroup() %>% 
  pivot_longer(cols = c(c("northeast","northcentral","south","west")),
               names_to = "area") %>%
  filter(value == 1) %>%
  select(-value) %>%
  identity()


```

```{r preprocessing}

basic_recipe = recipe(lnwage ~ ., data = train_set_transformed) %>% 
  update_role(ID,new_role = "id variable") %>% 
  step_YeoJohnson(c("exppsq","expfsq"))%>% 
  step_other(profession,threshold = 0.025)%>% 
  step_normalize(all_numeric(), -all_outcomes())

dummy_recipe = basic_recipe %>% 
  step_dummy(c(profession, race, area)) %>% 
  step_interact(~edyrs:starts_with("race"))

encode_recipe = basic_recipe %>%
  step_lencode_glm(c(profession, race, area),outcome = vars(lnwage)) %>% 
  step_interact(~edyrs:race)


```

```{r set_models_spec}

linear_model = linear_reg() %>% 
  set_engine("lm")

lasso_model = linear_reg(penalty = tune(), mixture = 1) %>% 
  set_engine("glmnet")

cart_model = decision_tree(cost_complexity = tune(), min_n = tune()) %>% 
   set_engine("rpart") %>% 
   set_mode("regression")

bag_cart_model = bag_tree() %>% 
   set_engine("rpart", times = 50L) %>% 
   set_mode("regression")

rf_model = rand_forest(mtry = tune(), min_n = tune(), trees = 1000) %>% 
   set_engine("ranger") %>% 
   set_mode("regression")

xgb_model = boost_tree(tree_depth = tune(), learn_rate = tune(),
                       loss_reduction = tune(), 
                       min_n = tune(), sample_size = tune(), trees = tune()) %>% 
   set_engine("xgboost") %>% 
   set_mode("regression")


```

```{r test_drive, eval=FALSE}

workflow() %>% 
  add_recipe(encode_recipe) %>% 
  add_model(lasso_model) %>% 
  fit(train_set_transformed)

```



```{r set_cross_validation_and_tuning}

cv_folds = train_set_transformed %>% 
  vfold_cv(v = 10,repeats = 5)


```

```{r estimation}

models_set = workflow_set(
  preproc = list(dummy = dummy_recipe,
                 encode = encode_recipe),
  models = list(linear = linear_model,
                lasso = lasso_model,
                tree = cart_model,
                bag_tree = bag_cart_model,
                xgb = xgb_model)
)

resample_res = models_set %>%
  workflow_map(
    fn = "tune_grid",
    resamples = cv_folds,
    grid = 25,
    control = control_grid(parallel_over = "everything")
  )




```

```{r evaluation}

resample_res %>% 
  collect_metrics() %>% 
  filter(.metric == "rmse") %>% 
  group_by(wflow_id) %>% 
  slice_min(2) %>% 
  select(wflow_id, mean,std_err) %>% 
  mutate(mse = mean ^ 2)

```

```{r prediction, eval=FALSE}

lasso_tune = workflow() %>% 
  add_recipe(encode_recipe) %>% 
  add_model(lasso_model) %>% 
  tune_grid(resamples = cv_folds, grid = 15)

lasso_fit = workflow() %>% 
  add_recipe(encode_recipe) %>% 
  add_model(lasso_model) %>% 
  finalize_workflow(select_best(lasso_tune,metric = "rmse")) %>% 
  fit(train_set)

lasso_fit %>% 
  predict(test_set) %>% 
  rename(lnwage = 1) %>% 
  bind_cols(select(test_set,ID)) %>% 
  relocate(ID) %>% 
  write_csv("C:\\Users\\Home\\Desktop\\test_submission.csv")


```

