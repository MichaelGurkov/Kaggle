---
title: "Modeling"
---
<style type="text/css">
  body{
  font-size: 16pt;
}
</style>

```{r include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE,
                      message = FALSE)

```

```{r load_libraries}

library(tidyverse)

library(tidymodels)

library(baguette)

```

```{r load_data}

data("train_set")

train_set =  train_set %>% 
  rename("ID" = 1) %>% 
  rename("target" = lnwage)

data("test_set")

```

```{r preprocessing}

preprocess_recipe = recipe(target ~ ., data = train_set) %>% 
  update_role(ID,new_role = "id variable") %>% 
  step_zv(all_predictors())
  
```

```{r set_models_spec}

lasso_model = workflow() %>% 
  add_recipe(preprocess_recipe) %>% 
  add_model(linear_reg(penalty = tune(),mixture = 1) %>% 
  set_engine("glmnet"))

# rf_model = workflow() %>% 
#   add_recipe(preprocess_recipe) %>% 
#   add_model(rand_forest(trees = 1000) %>%
#   set_mode("regression") %>%
#   set_engine("ranger"))
# 
# 
# bag_tree_model = workflow() %>% 
#   add_recipe(preprocess_recipe) %>% 
#   add_model(bag_tree() %>% 
#   set_engine("rpart", times = 25) %>%
#   set_mode("regression"))

 



```

```{r set_cross_validation_and_tuning}

cv_folds = train_set %>% 
  vfold_cv(v = 10)

param_grid = grid_regular(penalty(),levels = 10)

```

```{r tune_models}

lasso_tune =  lasso_model %>%
  tune_grid(resamples = cv_folds,
            grid = param_grid,
            metrics = metric_set(rmse))

# rf_fit = rf_model %>% 
#   fit_resamples(cv_folds, data = train_set)

```

```{r evaluate_models}

lasso_eval = lasso_tune %>% 
              show_best() %>% 
              slice(1) %>% 
              select(-c(".config","penalty")) %>% 
              mutate(model = "lasso")

# rf_eval = rf_fit %>% 
#   collect_metrics() %>% 
#   filter(.metric == "rmse") %>% 
#   mutate(model = "rf") %>% 
#   select(-".config")




```

```{r last_fit_and_predict}

lasso_fit = lasso_model %>% 
  finalize_workflow(parameters = select_best(lasso_tune)) %>% 
  fit(train_set)


lasso_pred = test_set %>%
  select(ID) %>%
  bind_cols(predict(lasso_fit, test_set))


```

