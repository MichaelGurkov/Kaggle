---
title: "Modeling"
---
<style type="text/css">
  body{
  font-size: 16pt;
}
</style>

```{r include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE,
                      message = FALSE)

```

```{r load_libraries}

library(tidyverse)

library(tidymodels)

library(embed)

library(workflowsets)

```

```{r parameters}

professions = c(
  "manager",
  "business",
  "financialop",
  "computer",
  "architect",
  "scientist",
  "socialworker",
  "postseceduc",
  "legaleduc",
  "artist",
  "lawyerphysician",
  "healthcare",
  "healthsupport",
  "protective",
  "foodcare",
  "building",
  "sales",
  "officeadmin",
  "farmer",
  "constructextractinstall",
  "production",
  "transport"
)

```

```{r load_data}

data("train_set")

train_set =  train_set %>% 
  rename(ID = 1) %>% 
  pivot_longer(cols = all_of(professions),names_to = "profession") %>% 
  filter(value == 1) %>% 
  select(-value)

data("test_set")

test_set = test_set %>% 
  pivot_longer(cols = all_of(professions),names_to = "profession") %>% 
  filter(value == 1) %>% 
  select(-value)

```

```{r preprocessing}

dummy_recipe = recipe(lnwage ~ ., data = train_set) %>% 
  update_role(ID,new_role = "id variable") %>% 
  step_spatialsign(c("exppsq","expfsq")) %>% 
  step_dummy(profession)

encode_recipe = recipe(lnwage ~ ., data = train_set) %>% 
  update_role(ID,new_role = "id variable") %>% 
  step_spatialsign(c("exppsq","expfsq")) %>% 
  step_lencode_glm(profession,outcome = "lnwage")

interaction_rec = encode_recipe %>% 
  step_interact(~profession:edyrs)
  
```

```{r set_models_spec}

linear_model = linear_reg() %>% 
  set_engine("lm")

lasso_model = linear_reg(penalty = tune(), mixture = 1) %>% 
  set_engine("glmnet")




```

```{r set_cross_validation_and_tuning}

cv_folds = train_set %>% 
  vfold_cv(v = 10, repeats = 3)


```

```{r estimation}

models_set = workflow_set(
  preproc = list(
    ohe = dummy_recipe,
    encode = encode_recipe,
    interact = interaction_rec
  ),
  models = list(linear = linear_model, lasso = lasso_model)
)

resample_res = models_set %>% 
  workflow_map(fn = "tune_grid",seed = 1101, resamples = cv_folds,
               grid = 10)




```

```{r evaluation}

resample_res %>% 
  collect_metrics() %>% 
  filter(.metric == "rmse") %>% 
  group_by(wflow_id) %>% 
  slice_min(2) %>% 
  select(wflow_id, mean,std_err) %>% 
  mutate(mse = mean ^ 2)

```

